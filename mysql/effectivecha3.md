深入理解MySQL索引
==================

创建合适的索引是sql性能调优中最重要的基数之一，创建合适的索引应先了解MySQL的架构细节，包括索引在硬盘上是如何组织的、索引和内存用法和操作方式，存储引擎的差异如何影响到索引的选择。

结合MySQL架构了解如下内容
    * MySQL索引各种可能的用途
    * 理解各种索引数据结构理论
    * 各种存储引擎的索引实现方式
    * 分区的MySQL索引

MySQL索引用法
--------------

索引除了可以读取数据时优化MySQL的性能，还有很对其他的功能
    * 保持数据完整性
    * 优化数据访问性能
    * 改进表的链接（join）操作
    * 对结果进行排序
    * 简化聚合数据操作

#### 数据完整性

MySQL用主键和唯一键(unique key)执行每个表中存储数据的唯一性等级
    * 每个表只能有一个主键，但可以有多个唯一键
    * 主键不能包含NULL值，唯一键可以包含NULL值，并且每个NULL值都是唯一的(NULL!=NULL)
    * 通过主键可以获取表中任意特定行
    * 如果定义了AUTO_INCREMNENT列，那么此列必须是主键的一部分

部分MySQL的存储引擎可以创建外键来保证数据完整性，外键不是索引，属于约束。通常外键约束实现的先决条件就是外键所在的表和外键参照的表都必须有索引，这样才能管理外键约束。目前只有InnoDB支持外键约束且不要求存在对应的索引，但建议添加外键约束时简历索引。MyISAM不支持外键，但仍可通过REFERENCES语法定义外键。

#### 优化数据访问

索引可以让优化器在执行查询的时候不必检索表中所有数据，通过限制需要访问的行数，来显著提高查询速度。

#### 表连接

除了在给定表上限制需要读取的数据外，索引的另一个主要用途就是快捷高效地在相关的表之间做链接操作，在需要链接的列上使用索引可以显著提升性能，并可以在另一个表中快速找到一个匹配的值。

#### 结果排序

索引把数据存储在一个有序的表格中，如果希望结果有序，那么就应该适当地是哦那个索引，通过ORDER BY关键字可以对任意SELECT语句的结果进行排序，如果在要排序的列上没有找到索引，MySQL一般会对获取的表进行内部排序，在高并发系统中使用预先建立的索引可以带来巨大的性能改进。

#### 聚合操作

索引还可以作为一种更方便的计算聚合结果的工具。

存储引擎
----------

存储引擎的功能和特性
    * 事务性和非事务性
    * 持久性和非持久性
    * 表和行级锁定
    * 不同的索引方法，B-树、B+树、散列和R-树
    * 聚簇索引和非聚簇索引
    * 主码索引和非主码索引
    * 数据压缩
    * 全文索引

MySQL常用的存储引擎
    * MyISAM是一种非事务性的存储引擎
    * InnoDB最流行的事务性存储引擎，5.5版本之后成为默认的存储引擎
    * Memory基于内存的、非事务性的非持久性的存储引擎

可以通过SHOW CREATE TABLE、SHOW TABLE STATUS、INFORMATION_SCHEMA.TABLES查看指定表的存储引擎

索引专业术语
-------------

常见的专业术语有
    * 索引技术，是关于不同数据结构如何用不同的方法访问底层信息的理论。包括B-树、B+树、R-树以及散列，每一种技术都采用不同的概念来实现一种特定目标或数据结构的优势；
    * 索引实现，关于MySQL及各种存储引擎实现不同的数据结构技术的方法，MyISAM引擎实现B-树的方法，InnoDB实现的方法就有所不同；
    * 索引类型，包括主键、唯一键、非主码索引、全文索引以及空间类型，每种类型支持在单一列、多列或者列的一部分上定义特定的索引类型，最后这些索引类型中的一个或多个会成为所谓的覆盖索引；

MySQL索引类型
--------------

MySQL支持在所有关系型数据库表中创建主键、唯一键、不唯一的非主码索引等多种类型的索引，在一些特定的存储引擎中，MySQL还支持存文本和空间索引类型。

MySQL内置的存储引擎对各种索引技术有不同的实现方式，包括B-树、B+树，R-树以及散列。

#### B-树

B-树数据结构支持数据插入、控制操作以及通过管理一系列树根状结构的彼此联通的节点中来做选择，B-树种索引节点用来告诉用户存储在叶子节点中的数据的顺序并帮助用户找到相应的数据，叶子节点则是用来存储数据的。

#### B+树

B+树结构是B-树的增强版本，它们最显著的不同点是B+树种底层数据时根据被提及的索引列进行排序的。同时还通过在叶子节点之间的附加引用来优化扫描性能。

#### 散列

散列将一种算法应用到给定值中以在底层数据存储系统中返回一个唯一的指针或位置，有点是始终以线性时间复杂度找到需要读取行的位置，而不像B-树那样需要横跨多层节点来确定位置。

#### 通信R-树

支持基于数据类型对几何数据进行管理，目前只有MyISAM使用R-树实现支持空间索引。只支持唯一的NOTNULL列。

#### 全文本

只有MyISAM支持，5.6将要在InnoDB中加入全文本功能，全文本索引在大规模系统中并没有什么使用价值，因为在这些大规模系统中有很多专门用于文本检索的产品。

Sphinx搜索服务器可以以插件存储引擎的方式整合以支持许多全文本特性并且还能和MySQL中的可用数据进行整合

MySQL的索引实现
----------------

不同的存储引擎对索引技术的使用有所不同，不同的实现对磁盘和内存使用情况有不同的影响。

#### MyISAM的B-树

主要实现主码索引、唯一索引以及非主码索引，MyISAM定义的索引信息存储在MYI文件中，默认块大小是1024字节，可以通过myisam_block_size定义。

在MyISAM中，非主码索引的B-树结构存储引擎索引值和一个指向主码数据的指针，MyISAM索引是在内存的一个公共键缓存中管理的，这个缓存的大小可以通过key_buffer_size或者其他命名键缓存来定义。

#### InnoDB的B+树聚簇主码

InnoDB在主码说因中使用了B+树，这种结构把所有数据都和对应的主码组织在一起，并且在叶子节点这一层上添加额外的向前和向后的指针。

在文件系统层面，所有InnoDB数据和索引信息都默认在公共InnoDB表空间中管理，否则管理员可以通过innodb——data_file_path变量指定文件路径，这是一个ibdata1的文件。可以通过innodb_file_per_table选项来定义InnoDB为每个表使用单独的表空间。
